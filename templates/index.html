<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Saathi â€“ Mental Health Companion</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<!-- Landing Page -->
<div id="landing">
    <div class="landing-overlay">
        <div class="landing-content">
            <div class="avatar">ğŸ¤–</div>
            <h1>Saathi</h1>
            <p>Your personal mental health companion, always ready to listen and support you.</p>
            <button class="start-btn" id="start-btn">Start Chatting Now</button>
        </div>
    </div>
</div>

<!-- Chat Interface -->
<div id="main-app" style="display:none;">
    <div class="chat-wrapper">
        <header>
            <div class="header-content">
                <h1>Saathi</h1>
                <p>Be kind to your mind</p>
                <!-- open planner in a new tab -->
                <button id="open-planner-btn" onclick="window.open('/planner','_blank')" title="Open Planner" style="margin-left:auto;padding:8px 12px;border-radius:8px;border:none;background:#10b981;color:#fff;cursor:pointer;">
                    Planner
                </button>
            </div>
        </header>

        <div id="chat-box" class="chat-box"></div>

        <!-- Quick replies hidden until name is entered -->
        <div class="quick-replies" id="quick-replies" style="display:none;">
            <div class="quick-row">
                <button onclick="sendQuick('I feel stressed')">ğŸ˜¢ Stressed</button>
                <button onclick="sendQuick('I am happy')">ğŸ˜Š Happy</button>
                <button onclick="sendQuick('I feel anxious')">ğŸ˜Ÿ Anxious</button>
                <button onclick="sendQuick('I feel calm')">ğŸ˜Œ Calm</button>
                <button onclick="sendQuick('I feel sad')">ğŸ˜” Sad</button>
            </div>
            <div class="quick-row">
                <button onclick="sendQuick('I feel angry')">ğŸ˜¡ Angry</button>
                <button onclick="sendQuick('I feel relaxed')">ğŸ˜´ Relaxed</button>
                <button onclick="sendQuick('I feel focused')">ğŸ§  Focused</button>
                <button onclick="sendQuick('I feel lonely')">ğŸ¤ Lonely</button>
                <button onclick="sendQuick('I feel excited')">ğŸ¤© Excited</button>
            </div>
        </div>

        <form id="chat-form">
            <input type="text" id="user-input" placeholder="Please enter your name to start..." autocomplete="off" required>
            <button type="submit">Send</button>
        </form>

        <button id="download-btn">ğŸ’¾ Save Conversation</button>
    </div>
</div>

<script>
document.getElementById("start-btn").addEventListener("click", () => {
    document.getElementById("landing").style.display = "none";
    document.getElementById("main-app").style.display = "block";
    addMessage("saathi", "Hello! Iâ€™m Saathi, your mental health companion. May I know your name?");
});

let chatHistory = [];
let userName = null;

const chatBox = document.getElementById("chat-box");
const chatForm = document.getElementById("chat-form");
const userInput = document.getElementById("user-input");
const quickReplies = document.getElementById("quick-replies");
const downloadBtn = document.getElementById("download-btn");

let thinkingElem = null; // reference to current thinking indicator

function addMessage(sender, message) {
    const msgDiv = document.createElement("div");
    msgDiv.classList.add("message", sender);
    if(sender === "user"){
        msgDiv.textContent = message;
    } else {
        msgDiv.innerHTML = `<span class="avatar">ğŸ¤–</span> ${message}`;
    }
    chatBox.appendChild(msgDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
    chatHistory.push({sender, message});
}

function showThinking(text = "Your Saathi is thinkingâ€¦") {
    // avoid duplicate
    if (thinkingElem) return;
    thinkingElem = document.createElement("div");
    thinkingElem.className = "message saathi thinking-container";
    thinkingElem.innerHTML = `
        <div class="thinking-inner">
            <div class="breathing-circle" aria-hidden="true"></div>
            <div class="thinking-text">${text}</div>
        </div>
    `;
    chatBox.appendChild(thinkingElem);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function hideThinking() {
    if (!thinkingElem) return;
    thinkingElem.remove();
    thinkingElem = null;
}

chatForm.addEventListener("submit", e => {
    e.preventDefault();
    let msg = userInput.value.trim();
    if(msg){
        sendMessage(msg);
        userInput.value = "";
    }
});

function sendQuick(msg){
    userInput.value = msg;
    sendMessage(msg);
}

async function sendMessage(msg){
    addMessage("user", msg);

    if(!userName){
        const EMOTIONS = ["happy","sad","angry","anxious","excited","stressed","calm","lonely","relaxed","tired","bored","scared","afraid","depressed","upset","ok","okay"];

        const nameRegex = /\b(?:my name is|call me|i am|i'm|im)\s+([A-Za-z][A-ZaZ'\-\s]*)/i;
        const match = msg.match(nameRegex);
        if(match){
            let nameCaptured = match[1].trim().split(/[,\.\!\?]/)[0].split(/\s+/)[0];
            if(nameCaptured.length >= 2 && !EMOTIONS.includes(nameCaptured.toLowerCase())){
                userName = nameCaptured.charAt(0).toUpperCase() + nameCaptured.slice(1).toLowerCase();
                addMessage("saathi", `Nice to meet you, ${userName}! How are you feeling today?`);
                userInput.placeholder = "How are you feeling today? ğŸ’›";
                quickReplies.style.display = "flex";
                return;
            }
        }

        if(msg.split(/\s+/).length === 1){
            const token = msg.replace(/[^A-Za-z'\-]/g, "");
            if(token.length >= 2 && !EMOTIONS.includes(token.toLowerCase())){
                userName = token.charAt(0).toUpperCase() + token.slice(1).toLowerCase();
                addMessage("saathi", `Nice to meet you, ${userName}! How are you feeling today?`);
                userInput.placeholder = "How are you feeling today? ğŸ’›";
                quickReplies.style.display = "flex";
                return;
            }
        }

        addMessage("saathi", "Hello! Iâ€™m Saathi, your mental health companion. May I know your name?");
        return;
    }

    try{
        // show breathing / thinking indicator while waiting
        showThinking();

        const res = await fetch("/chat", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({message: msg})
        });

        // hide indicator as soon as we have a response (prevents cutting)
        hideThinking();

        const data = await res.json();
        addMessage("saathi", data.reply);
    } catch(err){
        hideThinking();
        addMessage("saathi", "âš ï¸ Error: Cannot reach server.");
    }
}

downloadBtn.addEventListener("click", () => {
    let text = chatHistory.map(m => `${m.sender.toUpperCase()}: ${m.message}`).join("\n");
    const blob = new Blob([text], {type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "saathi_chat.txt";
    a.click();
    URL.revokeObjectURL(url);
});

// simple helper to avoid XSS in small app
function escapeHtml(s){
    if(!s) return "";
    return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
</script>
</body>
</html>
