<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Saathi â€“ Mental Health Companion</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<!-- Landing Page -->
<div id="landing">
    <div class="landing-overlay">
        <div class="landing-content">
            <div class="avatar">ğŸ¤–</div>
            <h1>Saathi</h1>
            <p>Your personal mental health companion, always ready to listen and support you.</p>
            <button class="start-btn" id="start-btn">Start Chatting Now</button>
        </div>
    </div>
</div>

<!-- Chat Interface -->
<div id="main-app" style="display:none;">
    <div class="chat-wrapper">
        <header>
            <div class="header-content">
                <h1>Saathi</h1>
                <p>Be kind to your mind</p>
                <button id="open-planner-btn" title="Open Planner" style="margin-left:auto;padding:8px 12px;border-radius:8px;border:none;background:#10b981;color:#fff;cursor:pointer;">Planner</button>
            </div>
        </header>

        <div id="chat-box" class="chat-box"></div>

        <!-- Planner (hidden by default) -->
        <div id="planner" class="planner-wrapper" style="display:none; margin-top:12px;">
            <div style="display:flex;align-items:center;gap:8px;">
                <h3 style="margin:0;flex:1;">Planner</h3>
                <button id="download-planner-btn" style="background:#2563eb;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;">Download Planner</button>
            </div>
            <form id="planner-form" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;margin-bottom:10px;">
                <input id="plan-title" placeholder="Title" required style="flex:1;min-width:160px;padding:8px;border-radius:8px;border:1px solid #ccc;">
                <input id="plan-date" type="date" style="padding:8px;border-radius:8px;border:1px solid #ccc;">
                <input id="plan-time" type="time" style="padding:8px;border-radius:8px;border:1px solid #ccc;">
                <input id="plan-notes" placeholder="Notes (optional)" style="flex:1;min-width:160px;padding:8px;border-radius:8px;border:1px solid #ccc;">
                <button type="submit" style="background:#10b981;color:#fff;padding:8px 12px;border:none;border-radius:8px;cursor:pointer;">Add</button>
            </form>
            <div id="planner-list" class="planner-list"></div>
        </div>

        <!-- Quick replies hidden until name is entered -->
        <div class="quick-replies" id="quick-replies" style="display:none;">
            <div class="quick-row">
                <button onclick="sendQuick('I feel stressed')">ğŸ˜¢ Stressed</button>
                <button onclick="sendQuick('I am happy')">ğŸ˜Š Happy</button>
                <button onclick="sendQuick('I feel anxious')">ğŸ˜Ÿ Anxious</button>
                <button onclick="sendQuick('I feel calm')">ğŸ˜Œ Calm</button>
                <button onclick="sendQuick('I feel sad')">ğŸ˜” Sad</button>
            </div>
            <div class="quick-row">
                <button onclick="sendQuick('I feel angry')">ğŸ˜¡ Angry</button>
                <button onclick="sendQuick('I feel relaxed')">ğŸ˜´ Relaxed</button>
                <button onclick="sendQuick('I feel focused')">ğŸ§  Focused</button>
                <button onclick="sendQuick('I feel lonely')">ğŸ¤ Lonely</button>
                <button onclick="sendQuick('I feel excited')">ğŸ¤© Excited</button>
            </div>
        </div>

        <form id="chat-form">
            <input type="text" id="user-input" placeholder="Please enter your name to start..." autocomplete="off" required>
            <button type="submit">Send</button>
        </form>

        <button id="download-btn">ğŸ’¾ Save Conversation</button>
    </div>
</div>

<script>
document.getElementById("start-btn").addEventListener("click", () => {
    document.getElementById("landing").style.display = "none";
    document.getElementById("main-app").style.display = "block";
    addMessage("saathi", "Hello! Iâ€™m Saathi, your mental health companion. May I know your name?");
});

let chatHistory = [];
let userName = null;

const chatBox = document.getElementById("chat-box");
const chatForm = document.getElementById("chat-form");
const userInput = document.getElementById("user-input");
const quickReplies = document.getElementById("quick-replies");
const downloadBtn = document.getElementById("download-btn");

let thinkingElem = null; // reference to current thinking indicator

function addMessage(sender, message) {
    const msgDiv = document.createElement("div");
    msgDiv.classList.add("message", sender);
    if(sender === "user"){
        msgDiv.textContent = message;
    } else {
        msgDiv.innerHTML = `<span class="avatar">ğŸ¤–</span> ${message}`;
    }
    chatBox.appendChild(msgDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
    chatHistory.push({sender, message});
}

function showThinking(text = "Your Saathi is thinkingâ€¦") {
    // avoid duplicate
    if (thinkingElem) return;
    thinkingElem = document.createElement("div");
    thinkingElem.className = "message saathi thinking-container";
    thinkingElem.innerHTML = `
        <div class="thinking-inner">
            <div class="breathing-circle" aria-hidden="true"></div>
            <div class="thinking-text">${text}</div>
        </div>
    `;
    chatBox.appendChild(thinkingElem);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function hideThinking() {
    if (!thinkingElem) return;
    thinkingElem.remove();
    thinkingElem = null;
}

chatForm.addEventListener("submit", e => {
    e.preventDefault();
    let msg = userInput.value.trim();
    if(msg){
        sendMessage(msg);
        userInput.value = "";
    }
});

function sendQuick(msg){
    userInput.value = msg;
    sendMessage(msg);
}

async function sendMessage(msg){
    addMessage("user", msg);

    // If name not yet set, try to detect patterns like "my name is John", "I am John", "I'm John"
    if(!userName){
        // match "my name is", "i am" or "i'm" followed by name
        const nameRegex = /\b(?:my name is|i am|i'm)\s+([A-Za-z][A-Za-z'\-\s]*)/i;
        const match = msg.match(nameRegex);
        if(match){
            // take first token of captured group as first name, strip punctuation
            let nameCaptured = match[1].trim().split(/[,\.\!\?]/)[0].split(/\s+/)[0];
            userName = nameCaptured.charAt(0).toUpperCase() + nameCaptured.slice(1).toLowerCase();
            addMessage("saathi", `Nice to meet you, ${userName}! How are you feeling today?`);
            userInput.placeholder = "How are you feeling today? ğŸ’›";
            quickReplies.style.display = "flex";
            return;
        }

        // If input is a single word, treat it as a name
        if(msg.split(/\s+/).length === 1){
            userName = msg.charAt(0).toUpperCase() + msg.slice(1);
            addMessage("saathi", `Nice to meet you, ${userName}! How are you feeling today?`);
            userInput.placeholder = "How are you feeling today? ğŸ’›";
            quickReplies.style.display = "flex";
            return;
        }

        // Otherwise, ask for name (keep existing flow)
        addMessage("saathi", "Hello! Iâ€™m Saathi, your mental health companion. May I know your name?");
        return;
    }

    try{
        // show breathing / thinking indicator while waiting
        showThinking();

        const res = await fetch("/chat", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({message: msg})
        });

        // hide indicator as soon as we have a response (prevents cutting)
        hideThinking();

        const data = await res.json();
        addMessage("saathi", data.reply);
    } catch(err){
        hideThinking();
        addMessage("saathi", "âš ï¸ Error: Cannot reach server.");
    }
}

downloadBtn.addEventListener("click", () => {
    let text = chatHistory.map(m => `${m.sender.toUpperCase()}: ${m.message}`).join("\n");
    const blob = new Blob([text], {type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "saathi_chat.txt";
    a.click();
    URL.revokeObjectURL(url);
});

// Planner UI logic
const plannerBtn = document.getElementById("open-planner-btn");
const plannerEl = document.getElementById("planner");
const plannerForm = document.getElementById("planner-form");
const plannerList = document.getElementById("planner-list");

plannerBtn.addEventListener("click", () => {
    // toggle planner
    plannerEl.style.display = plannerEl.style.display === "none" ? "block" : "none";
    if (plannerEl.style.display === "block") {
        loadPlanner();
    }
});

async function loadPlanner(){
    plannerList.innerHTML = "<p>Loadingâ€¦</p>";
    try {
        const res = await fetch("/planner_items");
        const items = await res.json();
        renderPlanner(items || []);
    } catch (e) {
        plannerList.innerHTML = "<p>Error loading planner.</p>";
    }
}

function renderPlanner(items){
    if(!items.length){
        plannerList.innerHTML = "<p>No tasks yet.</p>";
        return;
    }
    plannerList.innerHTML = "";
    items.sort((a,b) => (a.date || "") > (b.date || "") ? 1 : -1);
    items.forEach(it => {
        const div = document.createElement("div");
        div.className = "planner-item";
        div.innerHTML = `
            <label style="display:flex;align-items:center;gap:8px;">
                <input type="checkbox" ${it.completed ? "checked" : ""} data-id="${it.id}" class="planner-complete">
                <strong style="${it.completed ? 'text-decoration:line-through;color:#6b7280':''}">${escapeHtml(it.title)}</strong>
                <small style="margin-left:8px;color:#374151">${it.date || ""} ${it.time || ""}</small>
            </label>
            <div style="display:flex;gap:8px;align-items:center;margin-top:6px;">
                <div style="flex:1;color:#374151">${escapeHtml(it.notes || "")}</div>
                <button data-id="${it.id}" class="planner-delete" style="background:#ef4444;color:#fff;border:none;padding:6px 8px;border-radius:6px;cursor:pointer;">Delete</button>
            </div>
        `;
        plannerList.appendChild(div);
    });

    // attach handlers
    document.querySelectorAll(".planner-delete").forEach(b => b.addEventListener("click", async (e) => {
        const id = e.currentTarget.dataset.id;
        await fetch(`/planner_items/${id}`, {method:"DELETE"});
        loadPlanner();
    }));
    document.querySelectorAll(".planner-complete").forEach(cb => cb.addEventListener("change", async (e) => {
        const id = e.currentTarget.dataset.id;
        const completed = e.currentTarget.checked;
        await fetch(`/planner_items/${id}`, {
            method: "PATCH",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({completed})
        });
        loadPlanner();
    }));
}

plannerForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const title = document.getElementById("plan-title").value.trim();
    const date = document.getElementById("plan-date").value;
    const time = document.getElementById("plan-time").value;
    const notes = document.getElementById("plan-notes").value.trim();
    if(!title) return;
    try {
        await fetch("/planner_items", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({title, date, time, notes})
        });
        plannerForm.reset();
        loadPlanner();
    } catch (err) {
        console.error(err);
    }
});

// Planner Download button: navigate to server endpoint to trigger file download (text format)
document.getElementById("download-planner-btn").addEventListener("click", (e) => {
    // download structured plain-text version
    window.location = "/download_planner_text";
});

// simple helper to avoid XSS in small app
function escapeHtml(s){
    if(!s) return "";
    return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
</script>
</body>
</html>
